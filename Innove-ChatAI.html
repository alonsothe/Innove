<!DOCTYPE html>
<html lang="es" data-scheme="dark" data-theme="planetado">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Innove AI — Ultra v4.1 (responsive)</title>
  <meta name="description" content="Innove AI: chat educativo con streaming, misiones y fondos animados. Versión mobile‑first con chat a pantalla completa, composer fijo, mejor contraste y toques accesibles."/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

  <!-- Markdown seguro + highlight -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- MathJax + mhchem (química) -->
  <script>
    window.MathJax = { tex: { packages: { '[+]': ['mhchem'] }, inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] }, options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] } };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/input/tex/extensions/mhchem.js"></script>

  <style>
    :root{
      --bg:#0f172a; --text:#e9f2ff; --muted:#b9c7e6;
      --glass:rgba(255,255,255,.12); --glass-strong:rgba(255,255,255,.22); --border:rgba(255,255,255,.22);
      --primary:#7dd3fc; --violet:#c4b5fd; --green:#34d399; --amber:#f59e0b; --rose:#fb7185;
      --shadow:0 18px 48px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06);
      --r2:16px; --r3:22px; --r4:28px; --rMax:999px; --maxw:1200px;
      --bubble:rgba(17,24,39,.9);
      --glow: drop-shadow(0 0 18px rgba(125,211,252,.25)) drop-shadow(0 0 36px rgba(196,181,253,.22));

      /* Nuevas vars mobile */
      --nav-h: 56px;           /* será recalculado en runtime */
      --composer-h: 116px;     /* textarea + botones */
      --safe-b: env(safe-area-inset-bottom, 0px);
    }
    html[data-scheme="light"]{
      --bg:#f7f9ff; --text:#0b1020; --muted:#334155;
      --glass:rgba(255,255,255,.86); --glass-strong:rgba(255,255,255,.95); --border:rgba(8,47,73,.14);
      --bubble:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow-x:hidden}

    /* ===== Fondos con parallax (desactivados en móvil/low-motion) ===== */
    .space-bg, .aurora, .neon-grid, .leaf-bg, .silver-bg, .sea-bg { position: fixed; inset:0; z-index:-4; pointer-events:none; display:none; will-change: transform; }
    .space-bg{ background-image:
        radial-gradient(1200px 800px at 70% -10%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(1000px 600px at 10% 110%, rgba(196,181,253,.22), transparent 60%),
        radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.35) 0, transparent 60%),
        radial-gradient(1.5px 1.5px at 80% 60%, rgba(255,255,255,.28) 0, transparent 60%),
        radial-gradient(1px 1px at 50% 90%, rgba(255,255,255,.22) 0, transparent 60%);
      animation: twinkle 8s linear infinite; opacity:.9;
    }
    @keyframes twinkle { 50%{ filter: drop-shadow(0 0 10px rgba(255,255,255,.35)); } }
    .aurora{ inset:-20% -10% auto -10%; height:60vh; z-index:-3; background: conic-gradient(from 180deg at 50% 50%, rgba(125,211,252,.2), rgba(196,181,253,.22), rgba(52,211,153,.18), rgba(125,211,252,.2)); filter: blur(90px) saturate(130%); animation: drift 18s ease-in-out infinite; opacity:.8; }
    @keyframes drift { 50%{ transform: translateY(-24px) translateX(20px) scale(1.04); } }
    .neon-grid{ z-index:-2; opacity:.28; background: linear-gradient(transparent 0 98%, rgba(124,58,237,.42) 98%) 0 0/100% 40px, linear-gradient(90deg, transparent 0 98%, rgba(56,189,248,.42) 98%) 0 0/40px 100%; transform: perspective(900px) rotateX(60deg) translateY(-35%); animation: pan 22s linear infinite; mask-image: radial-gradient(60% 50% at 50% 30%, #000 60%, transparent 100%); }
    @keyframes pan{ to { background-position: 0 40px, 40px 0; } }
    .leaf-bg{ z-index:-3; opacity:.92; background: radial-gradient(800px 500px at 20% -10%, rgba(34,197,94,.16), transparent 60%), radial-gradient(700px 500px at 90% 120%, rgba(34,197,94,.12), transparent 60%), repeating-linear-gradient(180deg, rgba(15,76,59,.08), rgba(15,76,59,.08) 1px, transparent 1px, transparent 28px), linear-gradient(180deg, rgba(240,253,244,.8), rgba(187,247,208,.65)); }
    .silver-bg{ background: radial-gradient(800px 800px at 50% 50%, rgba(255,255,255,.35), rgba(224,224,224,.05) 60%, transparent 80%), linear-gradient(180deg, #fafafa, #d5d6db); opacity:.8; filter: blur(2px); }
    .sea-bg{ background: radial-gradient(600px 400px at 80% 20%, rgba(3,105,161,.25), transparent 60%), radial-gradient(600px 400px at 20% 80%, rgba(2,132,199,.25), transparent 60%), linear-gradient(180deg, #cffafe, #bae6fd); opacity:.82; }
    html[data-theme="planetado"] .space-bg, html[data-theme="planetado"] .neon-grid, html[data-theme="planetado"] .aurora{ display:block; }
    html[data-theme="neon"] .neon-grid{ display:block; opacity:.5 }
    html[data-theme="aurora"] .aurora{ display:block; opacity:.95; filter: blur(100px) saturate(150%); }
    html[data-theme="hoja"] .leaf-bg{ display:block; }
    html[data-theme="plateado"] .silver-bg{ display:block; }
    html[data-theme="mar"] .sea-bg{ display:block; }
    @media (max-width: 720px), (prefers-reduced-motion: reduce){
      .neon-grid, .aurora{ display:none !important; }
    }

    /* ===== App layout ===== */
    .wrap{max-width:var(--maxw); margin:0 auto; padding:12px;}
    .app{min-height:100dvh; display:flex; flex-direction:column;}

    /* ===== Nav ===== */
    .nav{position:sticky; top:8px; z-index:60; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:18px; background:var(--glass-strong); border:1px solid var(--border); box-shadow:var(--shadow); backdrop-filter:saturate(140%) blur(10px);}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px; text-transform:uppercase; background: linear-gradient(90deg, #fff, #bfe3ff, #e7d9ff, #fff); -webkit-background-clip:text; background-clip:text; color:transparent; animation: shimmer 5s linear infinite; font-size:clamp(.9rem, 2.5vw, 1.05rem);}
    @keyframes shimmer{ 0%{ background-position:0% } 100%{ background-position:200% } }
    .logo{width:32px;height:32px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#fff 8%, rgba(125,211,252,.9) 20%, rgba(196,181,253,.85) 45%, rgba(52,211,153,.35) 70%, transparent 75%); filter: var(--glow);}    
    .hint{color:var(--muted); font-size:.92em}

    /* ===== Panel ===== */
    .panel{background:var(--glass); backdrop-filter: blur(16px) saturate(160%); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow); transition: transform .25s ease, box-shadow .25s ease;}
    .panel:hover{ transform: translateY(-2px) scale(1.002); box-shadow:0 24px 60px rgba(0,0,0,.4) }

    /* ===== Grid principal ===== */
    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; margin-top:12px; flex:1;}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr; gap:12px} }

    /* ===== Chat: mobile-first fullscreen ===== */
    .chat-panel{ display:flex; flex-direction:column; padding:12px; }
    .toolbar{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px; flex-wrap:wrap}
    .chat{display:flex; flex-direction:column; gap:12px; padding:12px; flex:1; min-height: 0; height:auto; overflow:auto; border-radius:18px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow: inset 0 0 18px rgba(2,132,199,.08); scroll-behavior:smooth; scroll-padding-bottom: 140px;}
    .msg{display:flex; gap:10px; align-items:flex-start; animation:pop-bounce .35s cubic-bezier(.2,.8,.2,1)}
    @keyframes pop-bounce{0%{opacity:0;transform:translateY(10px) scale(.98)}60%{opacity:1;transform:translateY(-2px) scale(1.01)}100%{transform:none}}
    .role{width:38px; height:38px; border-radius:12px; display:grid; place-items:center; font-size:18px; border:1px solid var(--border); background:rgba(255,255,255,.12)}
    .bubble{position:relative; padding:12px 14px; border-radius:16px; border:1px solid var(--border); background:var(--bubble); box-shadow: inset 0 0 0 1px rgba(255,255,255,.02); line-height:1.45}
    html[data-scheme="light"] .bubble{ background:#fff; }
    .msg.user .bubble{background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06))}
    .msg.ai .bubble{background:linear-gradient(180deg, rgba(124,58,237,.16), rgba(255,255,255,.06))}
    .bubble .tools{position:absolute; top:6px; right:6px; display:flex; gap:6px; opacity:0; transition:opacity .2s}
    .bubble:hover .tools{opacity:1}

    /* Composer fijo (sticky) */
    .composer-wrap{position:sticky; bottom:0; left:0; right:0; padding:10px 0 8px; background: linear-gradient(180deg, transparent, rgba(0,0,0,.35) 35%, rgba(0,0,0,.55)); border-bottom-left-radius:20px; border-bottom-right-radius:20px; margin-top:12px}
    .uploader{padding:10px; border-radius:14px; border:1px dashed var(--border); display:flex; gap:10px; align-items:center; justify-content:space-between}
    .file-list{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .thumb, .pdficon{width:70px; height:70px; object-fit:cover; border-radius:10px; border:1px solid var(--border); display:grid; place-items:center; background:rgba(255,255,255,.06)}
    .composer{display:grid; grid-template-columns:1fr auto; gap:10px; padding-bottom: max(0px, var(--safe-b));}
    textarea{min-height:60px; max-height:240px; resize:vertical; padding:12px 14px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.10); color:var(--text); outline:none; font-size:1.02em; transition: box-shadow .2s}
    html[data-scheme="light"] textarea{ background:#fff }
    textarea:focus{box-shadow:0 0 0 3px rgba(125,211,252,.3)}
    button{padding:12px 16px; border-radius:14px; border:1px solid transparent; background:linear-gradient(135deg,var(--primary),var(--violet)); color:#0b1020; font-weight:800; cursor:pointer; box-shadow:0 0 16px rgba(125,211,252,.22); position:relative; overflow:hidden; transform:translateZ(0)}
    button::after{content:""; position:absolute; inset:0; opacity:0; background:radial-gradient(120px 120px at var(--x,50%) var(--y,50%), rgba(255,255,255,.45), transparent 60%); transition:opacity .25s}
    button:hover::after{opacity:1}

    /* Userbar + ajustes compactos en móvil */
    .userbar{display:flex; align-items:center; flex-wrap:wrap; gap:10px; margin:10px 0; padding:10px 12px}
    .avatar{width:40px; height:40px; border-radius:50%; background:linear-gradient(180deg,#f3e8ff,#e0f2ff); display:grid; place-items:center; font-size:1.35em; filter:var(--glow)}

    /* Pills/Chips */
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid var(--border); background:var(--glass-strong); cursor:pointer; user-select:none}
    .theme-panel{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .theme-pill{display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid var(--border); background:var(--glass-strong); cursor:pointer; font-weight:700; position:relative}
    .theme-pill[aria-pressed="true"]{ box-shadow:0 0 0 6px rgba(125,211,252,.12); }
    .theme-pill[aria-pressed="true"]::before{ content:""; position:absolute; inset:-1px; border-radius:inherit; padding:1px; background:linear-gradient(90deg, var(--primary), var(--violet), var(--primary)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: borderflow 2.5s linear infinite; }
    @keyframes borderflow{ to{ background-position:200% 0 } }

    /* Botón scroll al final */
    .toBottom{position:fixed; right:14px; bottom:calc(14px + var(--safe-b)); z-index:70; padding:10px 12px; border-radius:14px; background:linear-gradient(135deg,var(--primary),var(--violet)); color:#0b1020; border:0; box-shadow:0 10px 24px rgba(2,132,199,.25); display:none}

    /* Indicador de escritura */
    .typing{display:inline-flex; gap:4px; align-items:center}
    .typing i{width:6px; height:6px; border-radius:999px; background:currentColor; opacity:.7; animation: bounce .9s infinite}
    .typing i:nth-child(2){ animation-delay:.15s }
    .typing i:nth-child(3){ animation-delay:.3s }
    @keyframes bounce{ 0%,80%,100%{ transform: translateY(0) } 40%{ transform: translateY(-4px) }}

    /* Accesibilidad y tipografía fluida */
    :where(h1,h2,h3){ margin: 0 0 .4em; line-height:1.2 }
    body{ font-size: clamp(15px, 2.5vw, 16px); }

    /* Reduce animaciones si el usuario lo pide */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition:none !important }
    }
  </style>
</head>
<body>
  <!-- Fondos -->
  <div class="space-bg" aria-hidden="true"></div>
  <div class="aurora" aria-hidden="true"></div>
  <div class="neon-grid" aria-hidden="true"></div>
  <div class="leaf-bg" aria-hidden="true"></div>
  <div class="silver-bg" aria-hidden="true"></div>
  <div class="sea-bg" aria-hidden="true"></div>

  <div class="wrap app">
    <nav class="nav panel" aria-label="Navegación" id="nav">
      <div class="brand"><div class="logo"></div> Innove AI — Ultra v4.1</div>
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
        <span class="hint">Atajos: <kbd>Ctrl/Cmd + Enter</kbd> enviar · <kbd>Ctrl/Cmd + K</kbd> enfocar</span>
        <button id="schemeBtn" class="theme-pill" aria-pressed="false">🌓 </button>
      </div>
    </nav>

    <!-- Perfil / niveles -->
    <div class="userbar panel">
      <div class="avatar" id="avatar">🦉</div>
      <select id="userselect" class="chip" aria-label="Seleccionar avatar"></select>
      <input id="usernameinput" class="chip" type="text" maxlength="16" placeholder="Tu nombre…"/>
      <button id="savebtn">Guardar</button>

      <div class="levelbar" style="min-width:240px; display:flex; align-items:center; gap:10px">
        <strong>Nivel <span id="lvl">1</span>/150</strong>
        <div class="xpwrap" style="flex:1; height:12px; background:rgba(255,255,255,.10); border:1px solid var(--border); border-radius:999px; position:relative; overflow:hidden"><div id="xpbar" class="xp" style="position:absolute; height:100%; left:0; top:0; background:linear-gradient(90deg,var(--primary),var(--violet)); background-size: 24px 24px; mask: linear-gradient(#000 0 0); animation: stripes 1.2s linear infinite; transition: width .5s ease; width:0%"></div></div>
        <span class="hint" id="xptext">0/100 XP</span>
      </div>

      <div class="hint">Proveedor: <b id="providerLabel">Innove AI</b></div>
    </div>

    <!-- Temas + modos -->
    <section class="panel" style="padding:12px; display:grid; gap:10px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
        <div>
          <div class="hint">Temas del índice</div>
          <div class="theme-panel" id="themePanel">
            <button class="theme-pill" data-theme="planetado" aria-pressed="true"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:linear-gradient(90deg,#7dd3fc,#c4b5fd)"></span>Planetado</button>
            <button class="theme-pill" data-theme="neon"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#a78bfa"></span>Neón</button>
            <button class="theme-pill" data-theme="aurora"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#7dd3fc"></span>Aurora</button>
            <button class="theme-pill" data-theme="hoja"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#34d399"></span>Hoja</button>
            <button class="theme-pill" data-theme="plateado"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#e5e7eb"></span>Plateado</button>
            <button class="theme-pill" data-theme="mar"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#60a5fa"></span>Mar</button>
          </div>
        </div>
        <div class="hint">El tema se guarda localmente. En móvil se prioriza rendimiento.</div>
      </div>
      <div class="theme-panel" id="modes" aria-label="Modos IA">
        <span class="chip" data-mode="informatico">🖥️ Informático</span>
        <span class="chip" data-mode="innove">🎨 Innove Creativo</span>
        <span class="chip" data-mode="medicina">🩺 Medicina</span>
        <span class="chip" data-mode="ingenieria">🛠️ Ingeniería</span>
        <span class="chip" data-mode="fisica">🧪 Física</span>
        <span class="chip" data-mode="quimica">⚗️ Química</span>
        <span class="chip" data-mode="ingles">🇬🇧 Inglés</span>
        <span class="chip" data-mode="espanol">🇪🇸 Español</span>
        <span class="chip" data-mode="frances">🇫🇷 Francés</span>
        <span class="chip" data-mode="chino">🇨🇳 Chino</span>
      </div>
    </section>

    <div class="panel" style="padding:10px 12px; margin-top:8px">
      <b>Novedades v4.1:</b> chat a pantalla completa en móvil, composer fijo, tap‑targets grandes, mejor contraste y rendimiento.
    </div>

    <div class="grid">
      <!-- CHAT -->
      <section class="panel chat-panel">
        <div class="toolbar">
          <div class="hint">Modelos · Streaming · Voz</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <label class="hint">Modelo</label>
            <select id="model" class="chip" aria-label="Modelo">
              <optgroup label="OpenAI">
                <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                <option value="gpt-4.1">gpt-4.1</option>
              </optgroup>
              <optgroup label="Anthropic">
                <option value="claude-3-haiku">claude-3-haiku</option>
                <option value="claude-3-5-sonnet">claude-3.5-sonnet</option>
              </optgroup>
              <optgroup label="Google">
                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
              </optgroup>
              <optgroup label="DeepSeek">
                <option value="deepseek-chat">deepseek-chat</option>
              </optgroup>
            </select>
            <label class="hint">Streaming</label>
            <select id="streaming" class="chip" aria-label="Streaming"><option value="on" selected>On</option><option value="off">Off</option></select>
            <label class="hint">Voz</label>
            <select id="tts" class="chip" aria-label="Text-to-Speech"><option value="off" selected>Off</option><option value="on">On</option></select>
          </div>
        </div>

        <div id="chat" class="chat" aria-live="polite"></div>

        <!-- Adjuntos + Composer sticky -->
        <div class="composer-wrap">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <div id="dropzone" class="uploader" style="flex:1" aria-label="Soltar archivos para adjuntar">
              <span class="hint">Arrastra y suelta imágenes, PDFs o audio</span>
              <div>
                <input type="file" id="fileInput" multiple />
                <label id="attachLabel" for="fileInput" class="chip" style="cursor:pointer">📎 Adjuntar</label>
                <button id="recordBtn" class="chip">🎙️ Grabar</button>
                <button id="clearBtn" class="chip">🧹 Limpiar</button>
              </div>
            </div>
            <div id="fileList" class="file-list" aria-live="polite"></div>
          </div>

          <div class="composer" style="margin-top:10px">
            <textarea id="prompt" placeholder="Escribe tu mensaje… Usa $...$ o $$...$$ para fórmulas (y \\ce{...} en química)." aria-label="Mensaje"></textarea>
            <button id="sendBtn">Enviar</button>
          </div>
        </div>
      </section>

      <!-- Lado derecho: Ajustes + Misiones -->
      <aside class="panel" style="padding:12px">
        <h3 style="margin:6px 0 10px">Ajustes</h3>
        <div class="theme-panel">
          <div>
            <label class="hint"><b>Esquema</b></label><br/>
            <select id="schemeSelect" class="chip"><option value="dark" selected>Oscuro</option><option value="light">Claro</option></select>
          </div>
          <div>
            <label class="hint"><b>XP diario</b></label><br/>
            <select id="streak" class="chip"><option value="off">Streak Off</option><option value="on" selected>Streak On (+10%)</option></select>
          </div>
          <div>
            <label class="hint"><b>Previsualizar PDF</b></label><br/>
            <select id="pdfPreview" class="chip"><option value="off">Off</option><option value="on" selected>On</option></select>
          </div>
          <div>
            <label class="hint"><b>Efectos</b></label><br/>
            <select id="fx" class="chip"><option value="on" selected>On</option><option value="off">Off</option></select>
          </div>
        </div>

        <h3 style="margin:18px 0 8px">Misiones diarias</h3>
        <div class="quests" id="quests"></div>
        <p class="hint" style="margin-top:10px">Completa misiones para ganar XP extra. ¡Sube de nivel y desbloquea emojis! 🔓</p>
        <p class="hint" style="margin-top:10px">Seguridad: no expongas claves en el cliente. Usa proxy/servidor.</p>
      </aside>
    </div>

    <footer style="text-align:center; margin:16px 0; opacity:.85; font-size:12px">Innove AI · © 2025 · Mobile‑first + gamificación + animaciones.</footer>
  </div>

  <button id="toBottom" class="toBottom" aria-label="Ir al final">⬇️ Al final</button>
  const OPENAI_KEY   = "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";           // Solo para Whisper STT y/o modelos GPT (DEMO)

  // (Opcional) Si tienes un proxy que unifica proveedores:
  const USE_PROXY = false;
  const PROXY_URL = "/api/ai/chat";

  // ================= Refs del DOM =================
  const chatEl = document.getElementById('chat');
  const promptEl = document.getElementById('prompt');
  const sendBtn = document.getElementById('sendBtn');
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');
  const recordBtn = document.getElementById('recordBtn');
  const clearBtn  = document.getElementById('clearBtn');
  const modelEl = document.getElementById('model');
  const providerEl = document.getElementById('provider');
  const streamingEl = document.getElementById('streaming');
  const ttsEl = document.getElementById('tts');
  const toBottomBtn = document.getElementById('toBottom');
  const themeSwitch = document.getElementById('themeSwitch');
  const reelsEl = document.getElementById('reels');
  const providerLabel = document.getElementById('providerLabel');

  // ================= Perfil / XP =================
  const avatarEl = document.getElementById('avatar');
  const userselect = document.getElementById('userselect');
  const usernameinput = document.getElementById('usernameinput');
  const savebtn = document.getElementById('savebtn');
  const levelEl = document.getElementById('lvl');
  const xpbar = document.getElementById('xpbar');
  const xptext = document.getElementById('xptext');

  let USER = {
    emoji: localStorage.getItem('innove-emoji') || '🦉',
    name:  localStorage.getItem('innove-name')  || 'Sofi',
    level: parseInt(localStorage.getItem('innove-level')||'1',10),
    xp:    parseInt(localStorage.getItem('innove-xp')||'0',10)
  };

  function xpFor(level){ return Math.min(150, level) * 100; }
  function addXP(amount){
    // Streak +10% si está activo
    if ((document.getElementById('streak')?.value||'on') === 'on') amount = Math.round(amount*1.1);
    USER.xp += amount;
    let need = xpFor(USER.level);
    while(USER.xp >= need && USER.level < 150){
      USER.xp -= need; USER.level++; need = xpFor(USER.level); flashLevelUp();
    }
    localStorage.setItem('innove-level', USER.level);
    localStorage.setItem('innove-xp', USER.xp);
    syncProfile();
  }
  // ...después de syncProfile();...
 function updateAvatarOptions() {
  const lvl = USER.level;
  userselect.querySelectorAll('option').forEach(opt => {
    const minLevel = parseInt(opt.getAttribute('data-level'), 10) || 1;
    opt.disabled = lvl < minLevel;
  });
  // Si el avatar actual está deshabilitado, selecciona el primero disponible
  if (userselect.options[userselect.selectedIndex].disabled) {
    for (const opt of userselect.options) {
      if (!opt.disabled) {
        userselect.value = opt.value;
        USER.emoji = opt.value;
        localStorage.setItem('innove-emoji', USER.emoji);
        syncProfile();
        break;
      }
    }
  }
  }
  updateAvatarOptions();

  function flashLevelUp(){
    const s = document.createElement('div');
    s.textContent = '⟡ ¡Nivel '+USER.level+'!';
    Object.assign(s.style,{position:'fixed',left:'50%',top:'16%',transform:'translate(-50%,-50%)',
      padding:'12px 16px',border:'1px solid var(--border)',borderRadius:'16px',
      background:'#fff',boxShadow:'0 0 24px rgba(2,132,199,.18)',zIndex:9999});
    document.body.appendChild(s); setTimeout(()=>s.remove(), 1800);
    confetti();
  }
  function syncProfile(){
    avatarEl.textContent = USER.emoji;
    usernameinput.value = USER.name;
    levelEl.textContent = USER.level;
    const need = xpFor(USER.level);
    const pct = Math.max(0, Math.min(100, Math.floor(100*(USER.xp/need))));
    xpbar.style.width = pct+'%';
    xptext.textContent = `${USER.xp}/${need} XP`;
  }
  syncProfile();
  userselect.value = USER.emoji;
  userselect.addEventListener('change', ()=>{ USER.emoji=userselect.value; localStorage.setItem('innove-emoji',USER.emoji); syncProfile(); });
  savebtn.addEventListener('click', ()=>{ USER.name=(usernameinput.value||'').trim()||'Sofi'; localStorage.setItem('innove-name',USER.name); showWelcome(); });

  // ================= Temas (bugfix reels selector) =================
  const savedTheme = localStorage.getItem('innove-theme') || 'white';
  applyTheme(savedTheme);
  reelsEl?.querySelectorAll('.reel').forEach(card=>{
    if(card.dataset.bg===savedTheme) card.classList.add('active');
    card.addEventListener('click',()=>{
      reelsEl.querySelectorAll('.reel').forEach(x=>x.classList.remove('active'));
      card.classList.add('active');
      applyTheme(card.dataset.bg);
      localStorage.setItem('innove-theme', card.dataset.bg);
    });
  });
  function applyTheme(key){
  document.body.classList.remove('dark');
  if(key==='white')  document.body.style.background='#ffffff';
  if(key==='silver') document.body.style.background='linear-gradient(90deg,#ffffff,#f1f5f9)';
  if(key==='aurora') document.body.style.background='linear-gradient(90deg,#e0f2ff,#f3e8ff)';
  if(key==='dark') {
    document.body.classList.add('dark');
    document.body.style.background='#0a0914';
  }
}
  // Dark switch persistente
  const darkOn = localStorage.getItem('innove-dark') === '1';
  if(darkOn){ document.body.classList.add('dark'); themeSwitch.classList.add('on'); }
  themeSwitch?.addEventListener('click',()=>{
    document.body.classList.toggle('dark');
    themeSwitch.classList.toggle('on');
    localStorage.setItem('innove-dark', document.body.classList.contains('dark') ? '1':'0');
  });

  // ================= Modos =================
 // ...existing code...
 const SYSTEM_PROMPTS = {
  informatico: "Eres Innove, un ordenador experto en programación y tecnología. Responde dudas sobre Python, C++, Java, JavaScript, HTML, CSS, React, Node.js, Express, SQL, MySQL, MongoDB y más. Explica con claridad, ejemplos prácticos y buenas prácticas. Si el usuario pregunta por código, escribe el código en bloques y comenta cada parte.",
  innove: "Eres Innove creativo, especializado en innovación y diseño especulativo. Propón ideas originales, metáforas visuales y soluciones fuera de lo común, siempre con rigor y fundamento.",
  medicina: "Eres tutor de medicina. Responde con base científica y ética, nunca sustituyes consulta médica. Explica diagnósticos, tratamientos y conceptos médicos con claridad y responsabilidad.",
  ingenieria: "Eres ingeniero senior. Descompón los problemas en pasos claros, prioriza la seguridad y la eficiencia. Si hay cálculos, muestra las fórmulas en <b>negrita</b> y explica cada variable.",
  fisica: "Eres físico profesional. Explica conceptos y problemas con intuición y rigor. Escribe las fórmulas en <b>negrita</b> y usa formato especial para distinguirlas. Da ejemplos y analogías cuando ayuden a entender.",
  quimica: "Eres químico experto. Explica mecanismos, estequiometría y seguridad. Las fórmulas químicas deben ir en <b>negrita</b> o formato especial. Nunca des instrucciones peligrosas.",
  ingles: "Eres tutor de inglés. Corrige textos, explica errores y da ejemplos claros. Usa tablas o listas para mostrar conjugaciones y vocabulario. Sé amable y motivador.",
  espanol: "Eres tutor de español. Corrige ortografía, gramática y estilo. Da ejercicios prácticos y explica las reglas con ejemplos.",
  frances: "Eres tutor de francés. Alterna explicaciones en francés y español. Da ejercicios de conjugación y conversación. Usa tablas para mostrar verbos.",
  chino: "Eres tutor de chino mandarín. Explica pinyin, tonos y caracteres básicos. Da ejemplos sencillos y ejercicios de pronunciación."
 };

  let mode = localStorage.getItem('iaMode') || 'filosofo';
  const modesEl = document.getElementById('modes');
  setActiveModeCard(mode);
  modesEl?.querySelectorAll('.mode-card').forEach(card=>{
    card.addEventListener('click', ()=>{ mode=card.dataset.mode; localStorage.setItem('iaMode',mode); setActiveModeCard(mode); showWelcome(); });
  });
  function setActiveModeCard(m){
    modesEl?.querySelectorAll('.mode-card').forEach(c=>c.classList.remove('active'));
    const c = modesEl?.querySelector(`[data-mode="${m}"]`); if(c) c.classList.add('active');
  }
  function showWelcome(){
    const pretty={informatico:'Informatico',innove:'Innove Creativo',medicina:'Medicina',ingenieria:'Ingeniería',fisica:'Física',quimica:'Química',ingles:'Inglés',espanol:'Español',frances:'Francés',chino:'Chino'};
    addMsg('ai', `🤖 <b>${pretty[mode]||mode}</b> activo. ¿En qué te ayudo, ${USER.name}?`);
  }

  // ================= Chat UI helpers =================
  function addMsg(role, html){
    const row=document.createElement('div'); row.className='msg '+role+' appear';
    const roleEl=document.createElement('div'); roleEl.className='role '+(role==='user'?'user':'ai'); roleEl.textContent=(role==='user'? USER.emoji : '🤖');
    const b=document.createElement('div'); b.className='bubble'; b.innerHTML=html;
    row.appendChild(roleEl); row.appendChild(b); chatEl.appendChild(row);
    chatEl.scrollTop=chatEl.scrollHeight; return b;
  }
  function esc(s){ return (s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Mostrar botón "al final"
  chatEl.addEventListener('scroll',()=>{
    const nearBottom = chatEl.scrollHeight - chatEl.scrollTop - chatEl.clientHeight < 120;
    toBottomBtn.style.display = nearBottom ? 'none' : 'block';
  });
  toBottomBtn.addEventListener('click',()=> chatEl.scrollTo({top:chatEl.scrollHeight, behavior:'smooth'}));

  // ================= Adjuntos (drag & drop) =================
  let attachments=[]; let mediaRecorder=null, chunks=[]; let recording=false;
  const dropzone = document.getElementById('dropzone');
  ;['dragenter','dragover'].forEach(ev=>dropzone.addEventListener(ev,(e)=>{e.preventDefault(); dropzone.style.borderColor='#60a5fa';}));
  ;['dragleave','drop'].forEach(ev=>dropzone.addEventListener(ev,(e)=>{e.preventDefault(); dropzone.style.borderColor='var(--border)';}));
  dropzone.addEventListener('drop', async (e)=>{
    const files = [...e.dataTransfer.files];
    for(const f of files){ await handleFile(f); }
    renderFiles();
  });

  fileInput?.addEventListener('change', async (e)=>{ for(const file of e.target.files){ await handleFile(file);} renderFiles(); fileInput.value=''; });
  clearBtn?.addEventListener('click', ()=>{ attachments=[]; renderFiles(); });

  async function handleFile(file){
    if(!file) return;
    if(file.type.startsWith('image/')){
      const dataUrl=await blobToDataURL(file);
      attachments.push({type:'image', name:file.name, dataUrl});
    } else if (file.type==='application/pdf'){
      const text=await extractPDFText(file,6);
      attachments.push({type:'pdf', name:file.name, text});
    } else if (file.type.startsWith('audio/')){
      attachments.push({type:'audio', name:file.name, blob:file});
    } else {
      alert('Tipo no soportado: '+file.type);
    }
  }
  function renderFiles(){
    fileList.innerHTML='';
    attachments.forEach((a,i)=>{
      const wrap=document.createElement('div'); wrap.className='badge';
      const btnX=document.createElement('button'); btnX.textContent='✖'; btnX.onclick=()=>{ attachments.splice(i,1); renderFiles(); };
      if(a.type==='image'){ const img=document.createElement('img'); img.src=a.dataUrl; img.className='thumb'; wrap.append('🖼️',img,a.name,btnX); }
      else if(a.type==='pdf'){ const div=document.createElement('div'); div.className='pdficon'; div.textContent='PDF'; wrap.append('📄',div,a.name,btnX); }
      else if(a.type==='audio'){ const audio=document.createElement('audio'); audio.controls=true; audio.src=URL.createObjectURL(a.blob); audio.style.width='160px'; wrap.append('🔊',audio,a.name,btnX); }
      fileList.appendChild(wrap);
    });
  }
  function blobToDataURL(blob){ return new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob); }); }

  // ================= Grabación + Whisper STT (OpenAI) =================
  recordBtn?.addEventListener('click', async ()=>{
    try{
      if(!recording){
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder=new MediaRecorder(stream); chunks=[];
        mediaRecorder.ondataavailable=(e)=>{ if(e.data.size>0) chunks.push(e.data); };
        mediaRecorder.onstop=async()=>{
          const blob=new Blob(chunks,{type:'audio/webm'});
          const text=await transcribe(blob);
          if(text) promptEl.value=(promptEl.value? (promptEl.value+'\n'): '')+text;
          attachments.push({type:'audio', name:'grabacion.webm', blob});
          renderFiles();
        };
        mediaRecorder.start(); recording=true; recordBtn.textContent='⏹️';
      } else {
        mediaRecorder.stop(); recording=false; recordBtn.textContent='🎙️';
      }
    }catch(err){ alert('No se pudo acceder al micrófono: '+err.message); }
  });

  async function transcribe(blob){
    if(!OPENAI_KEY){ console.warn('Sin OPENAI_KEY para STT'); return ''; }
    const fd=new FormData(); fd.append('file', blob, 'audio.webm'); fd.append('model','whisper-1');
    const resp=await fetch('https://api.openai.com/v1/audio/transcriptions',{method:'POST', headers:{'Authorization':'Bearer '+OPENAI_KEY}, body:fd});
    if(!resp.ok){ console.warn('STT error', await resp.text()); return ''; }
    const data=await resp.json(); return data.text||'';
  }

  // ================= PDF.js extracción =================
  async function extractPDFText(file, maxPages=5){
    const arrayBuf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data: arrayBuf}).promise;
    let text=''; const pages=Math.min(pdf.numPages, maxPages);
    for(let i=1;i<=pages;i++){
      const page=await pdf.getPage(i);
      const content=await page.getTextContent();
      const strings=content.items.map(it=> it.str).join(' ');
      text += `\n\n[Página ${i}]\n` + strings;
    }
    return text.slice(0, 16000);
  }

  // ================= Prompt del sistema =================
  function buildSystemPrompt(){
    const base = SYSTEM_PROMPTS[mode] || '';
    const depth = Math.min(150,USER.level);
    let s = `${base}\n\nEres Innove. Usuario: ${USER.name} ${USER.emoji}. Ajusta la explicación a Nivel ${depth}/150.`;
    if(attachments.some(a=>a.type==='pdf')) s += "\n\nNota: el PDF puede estar incompleto (primeras páginas).";
    return s;
  }

  // ================= Proveedor & modelo =================
  providerEl?.addEventListener('change',()=> providerLabel.textContent = providerEl.options[providerEl.selectedIndex].textContent);
  modelEl?.addEventListener('change',()=>{ const p = detectProvider(modelEl.value); providerEl.value = p; providerLabel.textContent = providerEl.options[providerEl.selectedIndex].textContent; });

  function detectProvider(modelName){
    if(/deepseek/i.test(modelName)) return 'deepseek';
    if(/^gpt[-_]/i.test(modelName)) return 'openai';
    return 'deepseek';
  }

  function buildMessagesForOpenAI(userText){
    const content = [];
    if(userText) content.push({type:'text', text:userText});
    for(const a of attachments){
      if(a.type==='image') content.push({type:'image_url', image_url:{ url: a.dataUrl }});
      if(a.type==='pdf')   content.push({type:'text', text:`Contenido extraído de PDF (${a.name}):\n${a.text}`});
    }
    return [
      { role:'system', content: buildSystemPrompt() },
      { role:'user',   content }
    ];
  }

  function buildMessagesForDeepSeek(userText){
    let txt = userText||'';
    const pdfs = attachments.filter(a=>a.type==='pdf');
    if(pdfs.length){ txt += '\n\n[Resumen de PDFs]\n' + pdfs.map(p => `(${p.name})\n${p.text}`).join('\n\n'); }
    const imgs = attachments.filter(a=>a.type==='image');
    if(imgs.length){ txt += `\n\n[${imgs.length} imagen(es) omitida(s) para DeepSeek (solo texto)].`; }
    return [
      { role:'system', content: buildSystemPrompt() },
      { role:'user',   content: txt }
    ];
  }

  async function callAI({provider, model, messages, stream}){
    if(USE_PROXY){
      return fetch(PROXY_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ provider, model, messages, stream }) });
    }
    if(provider==='deepseek'){
      return fetch('https://api.deepseek.com/v1/chat/completions',{
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+DeepSeek_KEY },
        body: JSON.stringify({ model, messages, stream })
      });
    } else {
      return fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+OPENAI_KEY },
        body: JSON.stringify({ model, messages, stream })
      });
    }
  }

  async function readStreamToHTML(resp, holder){
    const reader = resp.body.getReader();
    const decoder = new TextDecoder('utf-8');
    let buf = '';
    while(true){
      const {done,value} = await reader.read();
      if(done) break;
      buf += decoder.decode(value,{stream:true});
      const chunks = buf.split('\n\n');
      buf = chunks.pop();
      for(const part of chunks){
        if(!part.startsWith('data:')) continue;
        const payload = part.slice(5).trim();
        if(payload==='[DONE]') return;
        try{
          const obj = JSON.parse(payload);
          const delta = obj.choices?.[0]?.delta?.content;
          if(delta){
            holder.innerHTML += esc(delta);
            chatEl.scrollTop = chatEl.scrollHeight;
          }
        }catch{}
      }
    }
  }

  async function send(){
    const model = (modelEl?.value || '').trim() || 'deepseek';
    const provider = providerEl?.value || detectProvider(model);
    const userText = (promptEl.value||'').trim();
    if(!userText && attachments.length===0) return;

    addMsg('user', `<b>${esc(USER.name)}</b>: ${esc(userText || '(sin texto)')}` + (attachments.length? `<div class="hint">Adjuntos: ${attachments.map(x=>x.type).join(', ')}</div>`:''));
    promptEl.value='';
    const holder = addMsg('ai', '<span class="hint">Pensando…</span>');

    // Construir mensajes segun proveedor
    const messages = (provider==='openai') ? buildMessagesForOpenAI(userText) : buildMessagesForDeepSeek(userText);
    const stream = (streamingEl?.value === 'on');

    try{
      const resp = await callAI({provider, model, messages, stream});
      if(!resp.ok){
        const t = await resp.text();
        holder.innerHTML = `<span class='danger'>Error ${provider.toUpperCase()}: ${esc(t)}</span>`;
        return;
      }

      if(stream){
        holder.innerHTML = '';
        await readStreamToHTML(resp, holder);
      } else {
        const data = await resp.json();
        const content = data.choices?.[0]?.message?.content || '(sin respuesta)';
        holder.innerHTML = esc(content).replace(/\n/g,'<br>');
      }

      if(ttsEl?.value==='on' && 'speechSynthesis' in window){
        const voices = speechSynthesis.getVoices();
        const esVoice = voices.find(v=>/es|es_/.test(v.lang));
        const ut = new SpeechSynthesisUtterance(holder.textContent.slice(0, 1400));
        if(esVoice) ut.voice = esVoice; ut.rate=1.05; speechSynthesis.speak(ut);
      }
      const words = (userText||'').split(/\s+/).filter(Boolean).length;
      addXP(10 + Math.min(90, Math.floor(words/5)));
      attachments=[]; renderFiles();
    }catch(err){
      holder.innerHTML = `<span class='danger'>${esc(err.message)}</span>`;
    }
  }

  // ================= Eventos de UI =================
  sendBtn?.addEventListener('click', send);
  promptEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
  window.addEventListener('keydown',(e)=>{ if((e.key==='k' || e.key==='K') && !e.ctrlKey && !e.metaKey){ e.preventDefault(); promptEl.focus(); }});

  // ================= Partículas (spark) =================
  const spark = document.getElementById('spark');
  const ctx = spark.getContext('2d');
  let W,H; let dots=[];
  function resize(){ W= spark.width = window.innerWidth; H= spark.height = window.innerHeight; }
  window.addEventListener('resize', resize); resize();
  function makeDots(n=90){ dots = Array.from({length:n},()=>({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*.4,vy:(Math.random()-.5)*.4})); }
  makeDots();
  function tick(){
    ctx.clearRect(0,0,W,H);
    for(const d of dots){ d.x+=d.vx; d.y+=d.vy; if(d.x<0||d.x>W) d.vx*=-1; if(d.y<0||d.y>H) d.vy*=-1; }
    // dibuja puntos
    ctx.globalAlpha=.7; dots.forEach(d=>{ ctx.beginPath(); ctx.arc(d.x,d.y,1.1,0,Math.PI*2); ctx.fillStyle='rgba(2,132,199,.7)'; ctx.fill(); });
    // líneas suaves
    for(let i=0;i<dots.length;i++){
      for(let j=i+1;j<dots.length;j++){
        const a=dots[i], b=dots[j]; const dx=a.x-b.x, dy=a.y-b.y; const dist=Math.hypot(dx,dy);
        if(dist<100){ ctx.globalAlpha = 1-dist/110; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.lineWidth=.6; ctx.strokeStyle='rgba(124,58,237,.6)'; ctx.stroke(); }
      }
    }
    requestAnimationFrame(tick);
  }4
  tick();

  // ================= Mini confeti =================
  function confetti(){
    const n=120; const frag=document.createDocumentFragment();
    for(let i=0;i<n;i++){
      const p=document.createElement('div');
      const size=4+Math.random()*6; const left=10+Math.random()*80; const rot=Math.random()*360;
      p.style.cssText=`position:fixed;top:-10px;left:${left}vw;width:${size}px;height:${size}px;background:hsl(${Math.random()*360} 90% 60%);border-radius:2px;transform:rotate(${rot}deg);z-index:9999;opacity:.9;`;
      document.body.appendChild(p);
      const y=100+Math.random()*100; const x=(Math.random()-.5)*40;
      p.animate([{transform:`translate(0,0) rotate(${rot}deg)`},{transform:`translate(${x}vw,${y}vh) rotate(${rot+720}deg)`}],{duration:1200+Math.random()*900, easing:'ease-out'}).onfinish=()=>p.remove();
    }
  }

  // ================= Bienvenida =================
  showWelcome();

  // ================= Nota de seguridad =================
  /*
   En PRODUCCIÓN usa un backend/proxy:
   - Node/Express ejemplo:
     app.post('/api/ai/chat', async (req,res)=>{
       const {provider, model, messages, stream} = req.body;
       const key = provider==='deepseek' ? process.env.DEEPSEEK_KEY : process.env.OPENAI_KEY;
       const url = provider==='deepseek' ? 'https://api.deepseek.com/v1/chat/completions' : 'https://api.openai.com/v1/chat/completions';
       const r = await fetch(url,{method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+key}, body:JSON.stringify({model,messages,stream})});
       // Puedes transferir SSE/NDJSON tal cual al cliente si stream===true
       r.body.pipe(res);
     });
  */
  </script>

</body>
</html>


