<!DOCTYPE html>
<html lang="es" data-scheme="dark" data-theme="planetado">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Innove AI — Ultra v4.1 (responsive)</title>
  <meta name="description" content="Innove AI: chat educativo con streaming, misiones y fondos animados. Versión mobile‑first con chat a pantalla completa, composer fijo, mejor contraste y toques accesibles."/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

  <!-- Markdown seguro + highlight -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- MathJax + mhchem (química) -->
  <script>
    window.MathJax = { tex: { packages: { '[+]': ['mhchem'] }, inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] }, options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] } };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/input/tex/extensions/mhchem.js"></script>

  <style>
    :root{
      --bg:#0f172a; --text:#e9f2ff; --muted:#b9c7e6;
      --glass:rgba(255,255,255,.12); --glass-strong:rgba(255,255,255,.22); --border:rgba(255,255,255,.22);
      --primary:#7dd3fc; --violet:#c4b5fd; --green:#34d399; --amber:#f59e0b; --rose:#fb7185;
      --shadow:0 18px 48px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06);
      --r2:16px; --r3:22px; --r4:28px; --rMax:999px; --maxw:1200px;
      --bubble:rgba(17,24,39,.9);
      --glow: drop-shadow(0 0 18px rgba(125,211,252,.25)) drop-shadow(0 0 36px rgba(196,181,253,.22));

      /* Nuevas vars mobile */
      --nav-h: 56px;           /* será recalculado en runtime */
      --composer-h: 116px;     /* textarea + botones */
      --safe-b: env(safe-area-inset-bottom, 0px);
    }
    html[data-scheme="light"]{
      --bg:#f7f9ff; --text:#0b1020; --muted:#334155;
      --glass:rgba(255,255,255,.86); --glass-strong:rgba(255,255,255,.95); --border:rgba(8,47,73,.14);
      --bubble:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow-x:hidden}

    /* ===== Fondos con parallax (desactivados en móvil/low-motion) ===== */
    .space-bg, .aurora, .neon-grid, .leaf-bg, .silver-bg, .sea-bg { position: fixed; inset:0; z-index:-4; pointer-events:none; display:none; will-change: transform; }
    .space-bg{ background-image:
        radial-gradient(1200px 800px at 70% -10%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(1000px 600px at 10% 110%, rgba(196,181,253,.22), transparent 60%),
        radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.35) 0, transparent 60%),
        radial-gradient(1.5px 1.5px at 80% 60%, rgba(255,255,255,.28) 0, transparent 60%),
        radial-gradient(1px 1px at 50% 90%, rgba(255,255,255,.22) 0, transparent 60%);
      animation: twinkle 8s linear infinite; opacity:.9;
    }
    @keyframes twinkle { 50%{ filter: drop-shadow(0 0 10px rgba(255,255,255,.35)); } }
    .aurora{ inset:-20% -10% auto -10%; height:60vh; z-index:-3; background: conic-gradient(from 180deg at 50% 50%, rgba(125,211,252,.2), rgba(196,181,253,.22), rgba(52,211,153,.18), rgba(125,211,252,.2)); filter: blur(90px) saturate(130%); animation: drift 18s ease-in-out infinite; opacity:.8; }
    @keyframes drift { 50%{ transform: translateY(-24px) translateX(20px) scale(1.04); } }
    .neon-grid{ z-index:-2; opacity:.28; background: linear-gradient(transparent 0 98%, rgba(124,58,237,.42) 98%) 0 0/100% 40px, linear-gradient(90deg, transparent 0 98%, rgba(56,189,248,.42) 98%) 0 0/40px 100%; transform: perspective(900px) rotateX(60deg) translateY(-35%); animation: pan 22s linear infinite; mask-image: radial-gradient(60% 50% at 50% 30%, #000 60%, transparent 100%); }
    @keyframes pan{ to { background-position: 0 40px, 40px 0; } }
    .leaf-bg{ z-index:-3; opacity:.92; background: radial-gradient(800px 500px at 20% -10%, rgba(34,197,94,.16), transparent 60%), radial-gradient(700px 500px at 90% 120%, rgba(34,197,94,.12), transparent 60%), repeating-linear-gradient(180deg, rgba(15,76,59,.08), rgba(15,76,59,.08) 1px, transparent 1px, transparent 28px), linear-gradient(180deg, rgba(240,253,244,.8), rgba(187,247,208,.65)); }
    .silver-bg{ background: radial-gradient(800px 800px at 50% 50%, rgba(255,255,255,.35), rgba(224,224,224,.05) 60%, transparent 80%), linear-gradient(180deg, #fafafa, #d5d6db); opacity:.8; filter: blur(2px); }
    .sea-bg{ background: radial-gradient(600px 400px at 80% 20%, rgba(3,105,161,.25), transparent 60%), radial-gradient(600px 400px at 20% 80%, rgba(2,132,199,.25), transparent 60%), linear-gradient(180deg, #cffafe, #bae6fd); opacity:.82; }
    html[data-theme="planetado"] .space-bg, html[data-theme="planetado"] .neon-grid, html[data-theme="planetado"] .aurora{ display:block; }
    html[data-theme="neon"] .neon-grid{ display:block; opacity:.5 }
    html[data-theme="aurora"] .aurora{ display:block; opacity:.95; filter: blur(100px) saturate(150%); }
    html[data-theme="hoja"] .leaf-bg{ display:block; }
    html[data-theme="plateado"] .silver-bg{ display:block; }
    html[data-theme="mar"] .sea-bg{ display:block; }
    @media (max-width: 720px), (prefers-reduced-motion: reduce){
      .neon-grid, .aurora{ display:none !important; }
    }

    /* ===== App layout ===== */
    .wrap{max-width:var(--maxw); margin:0 auto; padding:12px;}
    .app{min-height:100dvh; display:flex; flex-direction:column;}

    /* ===== Nav ===== */
    .nav{position:sticky; top:8px; z-index:60; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:18px; background:var(--glass-strong); border:1px solid var(--border); box-shadow:var(--shadow); backdrop-filter:saturate(140%) blur(10px);}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px; text-transform:uppercase; background: linear-gradient(90deg, #fff, #bfe3ff, #e7d9ff, #fff); -webkit-background-clip:text; background-clip:text; color:transparent; animation: shimmer 5s linear infinite; font-size:clamp(.9rem, 2.5vw, 1.05rem);}
    @keyframes shimmer{ 0%{ background-position:0% } 100%{ background-position:200% } }
    .logo{width:32px;height:32px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#fff 8%, rgba(125,211,252,.9) 20%, rgba(196,181,253,.85) 45%, rgba(52,211,153,.35) 70%, transparent 75%); filter: var(--glow);}    
    .hint{color:var(--muted); font-size:.92em}

    /* ===== Panel ===== */
    .panel{background:var(--glass); backdrop-filter: blur(16px) saturate(160%); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow); transition: transform .25s ease, box-shadow .25s ease;}
    .panel:hover{ transform: translateY(-2px) scale(1.002); box-shadow:0 24px 60px rgba(0,0,0,.4) }

    /* ===== Grid principal ===== */
    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; margin-top:12px; flex:1;}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr; gap:12px} }

    /* ===== Chat: mobile-first fullscreen ===== */
    .chat-panel{ display:flex; flex-direction:column; padding:12px; }
    .toolbar{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px; flex-wrap:wrap}
    .chat{display:flex; flex-direction:column; gap:12px; padding:12px; flex:1; min-height: 0; height:auto; overflow:auto; border-radius:18px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow: inset 0 0 18px rgba(2,132,199,.08); scroll-behavior:smooth; scroll-padding-bottom: 140px;}
    .msg{display:flex; gap:10px; align-items:flex-start; animation:pop-bounce .35s cubic-bezier(.2,.8,.2,1)}
    @keyframes pop-bounce{0%{opacity:0;transform:translateY(10px) scale(.98)}60%{opacity:1;transform:translateY(-2px) scale(1.01)}100%{transform:none}}
    .role{width:38px; height:38px; border-radius:12px; display:grid; place-items:center; font-size:18px; border:1px solid var(--border); background:rgba(255,255,255,.12)}
    .bubble{position:relative; padding:12px 14px; border-radius:16px; border:1px solid var(--border); background:var(--bubble); box-shadow: inset 0 0 0 1px rgba(255,255,255,.02); line-height:1.45}
    html[data-scheme="light"] .bubble{ background:#fff; }
    .msg.user .bubble{background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06))}
    .msg.ai .bubble{background:linear-gradient(180deg, rgba(124,58,237,.16), rgba(255,255,255,.06))}
    .bubble .tools{position:absolute; top:6px; right:6px; display:flex; gap:6px; opacity:0; transition:opacity .2s}
    .bubble:hover .tools{opacity:1}

    /* Composer fijo (sticky) */
    .composer-wrap{position:sticky; bottom:0; left:0; right:0; padding:10px 0 8px; background: linear-gradient(180deg, transparent, rgba(0,0,0,.35) 35%, rgba(0,0,0,.55)); border-bottom-left-radius:20px; border-bottom-right-radius:20px; margin-top:12px}
    .uploader{padding:10px; border-radius:14px; border:1px dashed var(--border); display:flex; gap:10px; align-items:center; justify-content:space-between}
    .file-list{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .thumb, .pdficon{width:70px; height:70px; object-fit:cover; border-radius:10px; border:1px solid var(--border); display:grid; place-items:center; background:rgba(255,255,255,.06)}
    .composer{display:grid; grid-template-columns:1fr auto; gap:10px; padding-bottom: max(0px, var(--safe-b));}
    textarea{min-height:60px; max-height:240px; resize:vertical; padding:12px 14px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.10); color:var(--text); outline:none; font-size:1.02em; transition: box-shadow .2s}
    html[data-scheme="light"] textarea{ background:#fff }
    textarea:focus{box-shadow:0 0 0 3px rgba(125,211,252,.3)}
    button{padding:12px 16px; border-radius:14px; border:1px solid transparent; background:linear-gradient(135deg,var(--primary),var(--violet)); color:#0b1020; font-weight:800; cursor:pointer; box-shadow:0 0 16px rgba(125,211,252,.22); position:relative; overflow:hidden; transform:translateZ(0)}
    button::after{content:""; position:absolute; inset:0; opacity:0; background:radial-gradient(120px 120px at var(--x,50%) var(--y,50%), rgba(255,255,255,.45), transparent 60%); transition:opacity .25s}
    button:hover::after{opacity:1}

    /* Userbar + ajustes compactos en móvil */
    .userbar{display:flex; align-items:center; flex-wrap:wrap; gap:10px; margin:10px 0; padding:10px 12px}
    .avatar{width:40px; height:40px; border-radius:50%; background:linear-gradient(180deg,#f3e8ff,#e0f2ff); display:grid; place-items:center; font-size:1.35em; filter:var(--glow)}

    /* Pills/Chips */
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid var(--border); background:var(--glass-strong); cursor:pointer; user-select:none}
    .theme-panel{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .theme-pill{display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid var(--border); background:var(--glass-strong); cursor:pointer; font-weight:700; position:relative}
    .theme-pill[aria-pressed="true"]{ box-shadow:0 0 0 6px rgba(125,211,252,.12); }
    .theme-pill[aria-pressed="true"]::before{ content:""; position:absolute; inset:-1px; border-radius:inherit; padding:1px; background:linear-gradient(90deg, var(--primary), var(--violet), var(--primary)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: borderflow 2.5s linear infinite; }
    @keyframes borderflow{ to{ background-position:200% 0 } }

    /* Botón scroll al final */
    .toBottom{position:fixed; right:14px; bottom:calc(14px + var(--safe-b)); z-index:70; padding:10px 12px; border-radius:14px; background:linear-gradient(135deg,var(--primary),var(--violet)); color:#0b1020; border:0; box-shadow:0 10px 24px rgba(2,132,199,.25); display:none}

    /* Indicador de escritura */
    .typing{display:inline-flex; gap:4px; align-items:center}
    .typing i{width:6px; height:6px; border-radius:999px; background:currentColor; opacity:.7; animation: bounce .9s infinite}
    .typing i:nth-child(2){ animation-delay:.15s }
    .typing i:nth-child(3){ animation-delay:.3s }
    @keyframes bounce{ 0%,80%,100%{ transform: translateY(0) } 40%{ transform: translateY(-4px) }}

    /* Accesibilidad y tipografía fluida */
    :where(h1,h2,h3){ margin: 0 0 .4em; line-height:1.2 }
    body{ font-size: clamp(15px, 2.5vw, 16px); }

    /* Reduce animaciones si el usuario lo pide */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition:none !important }
    }
  </style>
</head>
<body>
  <!-- Fondos -->
  <div class="space-bg" aria-hidden="true"></div>
  <div class="aurora" aria-hidden="true"></div>
  <div class="neon-grid" aria-hidden="true"></div>
  <div class="leaf-bg" aria-hidden="true"></div>
  <div class="silver-bg" aria-hidden="true"></div>
  <div class="sea-bg" aria-hidden="true"></div>

  <div class="wrap app">
    <nav class="nav panel" aria-label="Navegación" id="nav">
      <div class="brand"><div class="logo"></div> Innove AI — Ultra v4.1</div>
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
        <span class="hint">Atajos: <kbd>Ctrl/Cmd + Enter</kbd> enviar · <kbd>Ctrl/Cmd + K</kbd> enfocar</span>
        <button id="schemeBtn" class="theme-pill" aria-pressed="false">🌓 </button>
      </div>
    </nav>

    <!-- Perfil / niveles -->
    <div class="userbar panel">
      <div class="avatar" id="avatar">🦉</div>
      <select id="userselect" class="chip" aria-label="Seleccionar avatar"></select>
      <input id="usernameinput" class="chip" type="text" maxlength="16" placeholder="Tu nombre…"/>
      <button id="savebtn">Guardar</button>

      <div class="levelbar" style="min-width:240px; display:flex; align-items:center; gap:10px">
        <strong>Nivel <span id="lvl">1</span>/150</strong>
        <div class="xpwrap" style="flex:1; height:12px; background:rgba(255,255,255,.10); border:1px solid var(--border); border-radius:999px; position:relative; overflow:hidden"><div id="xpbar" class="xp" style="position:absolute; height:100%; left:0; top:0; background:linear-gradient(90deg,var(--primary),var(--violet)); background-size: 24px 24px; mask: linear-gradient(#000 0 0); animation: stripes 1.2s linear infinite; transition: width .5s ease; width:0%"></div></div>
        <span class="hint" id="xptext">0/100 XP</span>
      </div>

      <div class="hint">Proveedor: <b id="providerLabel">Innove AI</b></div>
    </div>

    <!-- Temas + modos -->
    <section class="panel" style="padding:12px; display:grid; gap:10px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
        <div>
          <div class="hint">Temas del índice</div>
          <div class="theme-panel" id="themePanel">
            <button class="theme-pill" data-theme="planetado" aria-pressed="true"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:linear-gradient(90deg,#7dd3fc,#c4b5fd)"></span>Planetado</button>
            <button class="theme-pill" data-theme="neon"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#a78bfa"></span>Neón</button>
            <button class="theme-pill" data-theme="aurora"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#7dd3fc"></span>Aurora</button>
            <button class="theme-pill" data-theme="hoja"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#34d399"></span>Hoja</button>
            <button class="theme-pill" data-theme="plateado"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#e5e7eb"></span>Plateado</button>
            <button class="theme-pill" data-theme="mar"><span class="sw" style="width:12px;height:12px;border-radius:50%;background:#60a5fa"></span>Mar</button>
          </div>
        </div>
        <div class="hint">El tema se guarda localmente. En móvil se prioriza rendimiento.</div>
      </div>
      <div class="theme-panel" id="modes" aria-label="Modos IA">
        <span class="chip" data-mode="informatico">🖥️ Informático</span>
        <span class="chip" data-mode="innove">🎨 Innove Creativo</span>
        <span class="chip" data-mode="medicina">🩺 Medicina</span>
        <span class="chip" data-mode="ingenieria">🛠️ Ingeniería</span>
        <span class="chip" data-mode="fisica">🧪 Física</span>
        <span class="chip" data-mode="quimica">⚗️ Química</span>
        <span class="chip" data-mode="ingles">🇬🇧 Inglés</span>
        <span class="chip" data-mode="espanol">🇪🇸 Español</span>
        <span class="chip" data-mode="frances">🇫🇷 Francés</span>
        <span class="chip" data-mode="chino">🇨🇳 Chino</span>
      </div>
    </section>

    <div class="panel" style="padding:10px 12px; margin-top:8px">
      <b>Novedades v4.1:</b> chat a pantalla completa en móvil, composer fijo, tap‑targets grandes, mejor contraste y rendimiento.
    </div>

    <div class="grid">
      <!-- CHAT -->
      <section class="panel chat-panel">
        <div class="toolbar">
          <div class="hint">Modelos · Streaming · Voz</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <label class="hint">Modelo</label>
            <select id="model" class="chip" aria-label="Modelo">
              <optgroup label="OpenAI">
                <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                <option value="gpt-4.1">gpt-4.1</option>
              </optgroup>
              <optgroup label="Anthropic">
                <option value="claude-3-haiku">claude-3-haiku</option>
                <option value="claude-3-5-sonnet">claude-3.5-sonnet</option>
              </optgroup>
              <optgroup label="Google">
                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
              </optgroup>
              <optgroup label="DeepSeek">
                <option value="deepseek-chat">deepseek-chat</option>
              </optgroup>
            </select>
            <label class="hint">Streaming</label>
            <select id="streaming" class="chip" aria-label="Streaming"><option value="on" selected>On</option><option value="off">Off</option></select>
            <label class="hint">Voz</label>
            <select id="tts" class="chip" aria-label="Text-to-Speech"><option value="off" selected>Off</option><option value="on">On</option></select>
          </div>
        </div>

        <div id="chat" class="chat" aria-live="polite"></div>

        <!-- Adjuntos + Composer sticky -->
        <div class="composer-wrap">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <div id="dropzone" class="uploader" style="flex:1" aria-label="Soltar archivos para adjuntar">
              <span class="hint">Arrastra y suelta imágenes, PDFs o audio</span>
              <div>
                <input type="file" id="fileInput" multiple />
                <label id="attachLabel" for="fileInput" class="chip" style="cursor:pointer">📎 Adjuntar</label>
                <button id="recordBtn" class="chip">🎙️ Grabar</button>
                <button id="clearBtn" class="chip">🧹 Limpiar</button>
              </div>
            </div>
            <div id="fileList" class="file-list" aria-live="polite"></div>
          </div>

          <div class="composer" style="margin-top:10px">
            <textarea id="prompt" placeholder="Escribe tu mensaje… Usa $...$ o $$...$$ para fórmulas (y \\ce{...} en química)." aria-label="Mensaje"></textarea>
            <button id="sendBtn">Enviar</button>
          </div>
        </div>
      </section>

      <!-- Lado derecho: Ajustes + Misiones -->
      <aside class="panel" style="padding:12px">
        <h3 style="margin:6px 0 10px">Ajustes</h3>
        <div class="theme-panel">
          <div>
            <label class="hint"><b>Esquema</b></label><br/>
            <select id="schemeSelect" class="chip"><option value="dark" selected>Oscuro</option><option value="light">Claro</option></select>
          </div>
          <div>
            <label class="hint"><b>XP diario</b></label><br/>
            <select id="streak" class="chip"><option value="off">Streak Off</option><option value="on" selected>Streak On (+10%)</option></select>
          </div>
          <div>
            <label class="hint"><b>Previsualizar PDF</b></label><br/>
            <select id="pdfPreview" class="chip"><option value="off">Off</option><option value="on" selected>On</option></select>
          </div>
          <div>
            <label class="hint"><b>Efectos</b></label><br/>
            <select id="fx" class="chip"><option value="on" selected>On</option><option value="off">Off</option></select>
          </div>
        </div>

        <h3 style="margin:18px 0 8px">Misiones diarias</h3>
        <div class="quests" id="quests"></div>
        <p class="hint" style="margin-top:10px">Completa misiones para ganar XP extra. ¡Sube de nivel y desbloquea emojis! 🔓</p>
        <p class="hint" style="margin-top:10px">Seguridad: no expongas claves en el cliente. Usa proxy/servidor.</p>
      </aside>
    </div>

    <footer style="text-align:center; margin:16px 0; opacity:.85; font-size:12px">Innove AI · © 2025 · Mobile‑first + gamificación + animaciones.</footer>
  </div>

  <button id="toBottom" class="toBottom" aria-label="Ir al final">⬇️ Al final</button>

  <script>
    // ===== Config (no metas claves en prod) =====
    const OPENAI_KEY = "fgrgtVtjTkXr2YgnUj2jjCdsSTZXkzdLIu1KryOXQcukqMLWI"; // ⚠️ Vacío por seguridad. Usa proxy.
    const USE_PROXY=false;    // true para usar tu backend
    const PROXY_URL="/api/ai/chat";

    // ===== Refs =====
    const chatEl=document.getElementById('chat');
    const promptEl=document.getElementById('prompt');
    const sendBtn=document.getElementById('sendBtn');
    const fileInput=document.getElementById('fileInput');
    const fileList=document.getElementById('fileList');
    const recordBtn=document.getElementById('recordBtn');
    const clearBtn=document.getElementById('clearBtn');
    const themePanel=document.getElementById('themePanel');
    const schemeBtn=document.getElementById('schemeBtn');
    const schemeSelect=document.getElementById('schemeSelect');
    const modelEl=document.getElementById('model');
    const streamingEl=document.getElementById('streaming');
    const ttsEl=document.getElementById('tts');
    const providerLabel=document.getElementById('providerLabel');
    const toBottomBtn=document.getElementById('toBottom');
    const nav=document.getElementById('nav');

    // Perfil
    const avatarEl=document.getElementById('avatar');
    const userselect=document.getElementById('userselect');
    const usernameinput=document.getElementById('usernameinput');
    const savebtn=document.getElementById('savebtn');
    const levelEl=document.getElementById('lvl');
    const xpbar=document.getElementById('xpbar');
    const xptext=document.getElementById('xptext');

    let attachments=[]; let mediaRecorder=null, chunks=[]; let recording=false;

    // ===== Ajusta alturas dinámicas (chat fullscreen en móvil) =====
    function recalcHeights(){
      const navH = nav.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--nav-h', navH + 'px');
    }
    new ResizeObserver(recalcHeights).observe(nav);
    recalcHeights();

    // ===== Perfil & niveles =====
    let USER={ emoji: localStorage.getItem('innove-emoji')||'🦉', name: localStorage.getItem('innove-name')||'Sofi', level: parseInt(localStorage.getItem('innove-level')||'1',10), xp: parseInt(localStorage.getItem('innove-xp')||'0',10) };
    const EMOJI_TIERS=[ {e:'🦉',lvl:1},{e:'🦊',lvl:3},{e:'🐱',lvl:5},{e:'🐼',lvl:7},{e:'🐧',lvl:10},{e:'🐶',lvl:12},{e:'🐻',lvl:15},{e:'🐸',lvl:18},{e:'🦁',lvl:25},{e:'🦄',lvl:30} ];
    function renderEmojiOptions(){ userselect.innerHTML=''; for(const {e,lvl} of EMOJI_TIERS){ const opt=document.createElement('option'); const unlocked=USER.level>=lvl; opt.value=e; opt.textContent=unlocked?`${e} (Lv ${lvl}+)`:`🔒 ${e} (Lv ${lvl})`; if(!unlocked) opt.disabled=true; if(USER.emoji===e) opt.selected=true; userselect.appendChild(opt);} }
    function xpFor(l){ return Math.min(150,l)*100; }
    function syncProfile(){ avatarEl.textContent=USER.emoji; levelEl.textContent=USER.level; const pct=Math.round(USER.xp/xpFor(USER.level)*100); xpbar.style.width=pct+'%'; xptext.textContent=`${USER.xp}/${xpFor(USER.level)} XP`; renderEmojiOptions(); }
    function addXP(n){ if((document.getElementById('streak')?.value||'on')==='on') n=Math.round(n*1.1); USER.xp+=n; let need=xpFor(USER.level); while(USER.xp>=need && USER.level<150){ USER.xp-=need; USER.level++; need=xpFor(USER.level); confetti(); } localStorage.setItem('innove-level',USER.level); localStorage.setItem('innove-xp',USER.xp); syncProfile(); }
    syncProfile();
    userselect.addEventListener('change',()=>{ USER.emoji=userselect.value; localStorage.setItem('innove-emoji',USER.emoji); syncProfile(); });
    savebtn.addEventListener('click',()=>{ USER.name=(usernameinput.value||'').trim()||'Sofi'; localStorage.setItem('innove-name',USER.name); addMsg('ai',`👋 Hola, ${USER.name}. Listo para aprender.`); });

    // ===== Temas y esquema =====
    const savedTheme=localStorage.getItem('innove-theme')||'planetado'; applyTheme(savedTheme);
    themePanel?.querySelectorAll('.theme-pill').forEach(btn=>{ btn.setAttribute('aria-pressed',String(btn.dataset.theme===savedTheme)); btn.addEventListener('click',()=>{ themePanel.querySelectorAll('.theme-pill').forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); applyTheme(btn.dataset.theme); localStorage.setItem('innove-theme',btn.dataset.theme); }); });
    function applyTheme(key){ document.documentElement.setAttribute('data-theme',key); }

    const savedScheme=localStorage.getItem('innove-scheme')||'dark'; applyScheme(savedScheme); schemeSelect.value=savedScheme;
    schemeSelect.addEventListener('change',()=>{ applyScheme(schemeSelect.value); localStorage.setItem('innove-scheme',schemeSelect.value); });
    schemeBtn.addEventListener('click',()=>{ const now=document.documentElement.getAttribute('data-scheme')==='dark'?'light':'dark'; applyScheme(now); schemeSelect.value=now; localStorage.setItem('innove-scheme',now); });
    function applyScheme(s){ document.documentElement.setAttribute('data-scheme',s); }

    // ===== Modos (prompts del sistema) =====
    const SYSTEM_PROMPTS={
      informatico: "Eres Innove, experto en programación y tecnología. Explica con claridad y ejemplos prácticos.",
      innove: "Eres Innove creativo. Propón ideas originales con fundamento.",
      medicina: "Eres tutor de medicina. Sé ético y basado en evidencia. No reemplazas consulta médica.",
      ingenieria: "Eres ingeniero senior. Descompón problemas, prioriza seguridad y eficiencia.",
      fisica: "Eres físico profesional. Ofrece intuición, fórmulas y ejemplos.",
      quimica: "Eres químico experto. Explica mecanismos y estequiometría. No des instrucciones peligrosas.",
      ingles: "Eres tutor de inglés. Corrige con amabilidad y ejemplos.",
      espanol: "Eres tutor de español. Mejora ortografía y estilo.",
      frances: "Eres tutor de francés. Alterna explicaciones en francés y español.",
      chino: "Eres tutor de chino. Explica pinyin, tonos y da ejercicios sencillos."
    };
    let mode = localStorage.getItem('iaMode')||'informatico';
    document.getElementById('modes')?.querySelectorAll('[data-mode]').forEach(chip=>{ if(chip.dataset.mode===mode) chip.style.outline='2px solid rgba(125,211,252,.6)'; chip.addEventListener('click',()=>{ mode=chip.dataset.mode; localStorage.setItem('iaMode',mode); document.querySelectorAll('#modes [data-mode]').forEach(c=>c.style.outline='none'); chip.style.outline='2px solid rgba(125,211,252,.6)'; addMsg('ai',`Modo activo: <b>${mode}</b>.`); }); });

    // ===== Micro‑interacciones (parallax suave en desktop) =====
    window.addEventListener('pointermove', (e)=>{
      if (window.matchMedia('(max-width: 720px)').matches) return; // evita coste en móvil
      const {innerWidth:w, innerHeight:h} = window; const x=(e.clientX-w/2)/w, y=(e.clientY-h/2)/h;
      const t = `translate(${x*-8}px, ${y*-6}px)`; const t2=`translate(${x*-16}px, ${y*-10}px)`; const t3=`translate(${x*6}px, ${y*4}px)`;
      document.querySelector('.space-bg')?.style.setProperty('transform', t);
      document.querySelector('.aurora')?.style.setProperty('transform', t2);
      document.querySelector('.neon-grid')?.style.setProperty('transform', t3);
    });

    // Botones ripple dirección
    document.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('pointerdown', (e)=>{
        const r = btn.getBoundingClientRect();
        btn.style.setProperty('--x', (e.clientX-r.left)+'px');
        btn.style.setProperty('--y', (e.clientY-r.top)+'px');
      })
    })

    // ===== Chat helpers =====
    function renderMarkdownTo(el,text){ const html=marked.parse(text,{breaks:true}); const safe=DOMPurify.sanitize(html,{USE_PROFILES:{html:true}}); el.innerHTML=safe; hljs?.highlightAll?.(); if(window.MathJax?.typesetPromise){ MathJax.typesetPromise([el]); } }
    function addMsg(role,text){ const row=document.createElement('div'); row.className='msg '+role; const roleEl=document.createElement('div'); roleEl.className='role '+(role==='user'?'user':'ai'); roleEl.textContent=(role==='user'?USER.emoji:'🤖'); const b=document.createElement('div'); b.className='bubble'; const tools=document.createElement('div'); tools.className='tools'; const copyBtn=document.createElement('button'); copyBtn.className='chip'; copyBtn.textContent='📋'; copyBtn.title='Copiar'; copyBtn.onclick=()=> navigator.clipboard.writeText(b.innerText||''); const likeBtn=document.createElement('button'); likeBtn.className='chip'; likeBtn.textContent='👍'; likeBtn.title='Me gusta'; likeBtn.onclick=(ev)=>{ burstEmoji(ev.clientX, ev.clientY, ['💜','✨','👍']); addXP(2); }; tools.appendChild(copyBtn); tools.appendChild(likeBtn); b.appendChild(tools); row.appendChild(roleEl); row.appendChild(b); chatEl.appendChild(row); renderMarkdownTo(b,String(text||'')); chatEl.scrollTop=chatEl.scrollHeight; return b; }
    function addStreamHolder(){ const b=addMsg('ai', `<span class='hint'>Pensando…</span> <span class='typing'><i></i><i></i><i></i></span>`); return b; }

    // ===== Envío =====
    async function send(){ const userText=promptEl.value.trim(); if(!userText && attachments.length===0) return; animateSendPlane(); addMsg('user',userText); promptEl.value=''; const holder=addStreamHolder(); const provider=detectProvider(modelEl.value); providerLabel.textContent=provider; const messages=buildMessages(userText); const stream=(streamingEl.value==='on'); try{ const resp=await callAI({provider,model:modelEl.value,messages,stream}); if(!resp.ok){ renderMarkdownTo(holder,'_Error en la llamada. Configura tu proxy o clave._'); return; } if(stream){ holder.innerHTML=''; const reader=resp.body.getReader(); const decoder=new TextDecoder(); let buffer=''; let acc=''; while(true){ const {value,done}=await reader.read(); if(done) break; buffer += decoder.decode(value,{stream:true}); const lines=buffer.split('\n'); buffer = lines.pop() || ''; for(const line of lines){ const s=line.trim(); if(!s || !s.startsWith('data:')) continue; const payload=s.slice(5).trim(); if(payload==='[DONE]') break; try{ const json=JSON.parse(payload); const delta=json.choices?.[0]?.delta?.content || ''; if(delta){ acc += delta; holder.textContent=acc; } }catch{} } } renderMarkdownTo(holder, holder.textContent); } else { const data=await resp.json(); const content=data.choices?.[0]?.message?.content || '(sin respuesta)'; renderMarkdownTo(holder, content); } if(ttsEl?.value==='on' && 'speechSynthesis' in window){ const voices=speechSynthesis.getVoices(); const es=voices.find(v=>/es|es_/i.test(v.lang)); const ut=new SpeechSynthesisUtterance(holder.textContent.slice(0, 1400)); if(es) ut.voice=es; ut.rate=1.05; speechSynthesis.speak(ut); } const words=(userText||'').split(/\s+/).filter(Boolean).length; addXP(10+Math.min(90,Math.floor(words/5))); attachments=[]; renderFiles(); jiggleToBottom(); }catch(err){ renderMarkdownTo(holder,'_'+(err.message||'Error')+'_'); } }
    sendBtn.addEventListener('click',send); promptEl.addEventListener('keydown',e=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); send(); }});

    // Hotkey: Ctrl/Cmd+K (no bloquea la tecla "k")
    window.addEventListener('keydown',e=>{ const tag=(document.activeElement?.tagName||'').toLowerCase(); if((e.key==='k'||e.key==='K')&&(e.ctrlKey||e.metaKey)&&!/input|textarea|select/.test(tag)){ e.preventDefault(); promptEl.focus(); }});

    // ===== Adjuntos =====
    const dropzone=document.getElementById('dropzone');
    ['dragenter','dragover'].forEach(ev=>dropzone.addEventListener(ev,e=>{e.preventDefault(); dropzone.style.borderColor='#60a5fa';}));
    ['dragleave','drop'].forEach(ev=>dropzone.addEventListener(ev,e=>{e.preventDefault(); dropzone.style.borderColor='var(--border)';}));
    document.getElementById('attachLabel').addEventListener('click',e=>{ e.preventDefault(); fileInput.click(); });
    fileInput.addEventListener('change',e=>{ for(const f of e.target.files){ handleFile(f);} renderFiles(); fileInput.value=''; });
    clearBtn.addEventListener('click',()=>{ attachments=[]; renderFiles(); });

    async function handleFile(file){ if(file.type.startsWith('image/')){ const url=URL.createObjectURL(file); attachments.push({type:'image',name:file.name,url}); } else if(file.type==='application/pdf'){ attachments.push({type:'pdf',name:file.name}); } else if(file.type.startsWith('audio/')){ attachments.push({type:'audio',name:file.name}); } }
    function renderFiles(){ fileList.innerHTML=''; for(const a of attachments){ const d=document.createElement('div'); d.className=(a.type==='image')?'thumb':'pdficon'; d.textContent=a.type.toUpperCase(); fileList.appendChild(d);} }

    // ===== Grabación =====
    recordBtn.addEventListener('click', async()=>{ try{ if(!window.isSecureContext){ alert('Grabar requiere HTTPS o localhost'); return; } if(!navigator.mediaDevices?.getUserMedia){ alert('Tu navegador no soporta audio'); return; } if(!recording){ const stream=await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder=new MediaRecorder(stream); chunks=[]; mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); }; mediaRecorder.onstop=()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); attachments.push({type:'audio',name:'grabacion.webm',blob}); renderFiles(); burstEmoji(window.innerWidth-80, window.innerHeight-80, ['🎙️','✨']); }; mediaRecorder.start(); recording=true; recordBtn.textContent='⏹️'; } else { mediaRecorder.stop(); recording=false; recordBtn.textContent='🎙️'; } }catch(err){ alert('No se pudo acceder al micrófono'); } });

    // ===== Proveedores =====
    function detectProvider(model){ if(/claude/i.test(model)) return 'anthropic'; if(/gemini/i.test(model)) return 'google'; if(/deepseek/i.test(model)) return 'deepseek'; return 'openai'; }
    function systemPrompt(){ const base=SYSTEM_PROMPTS[mode]||''; const depth=Math.min(150,USER.level); let s = `${base}\n\nEres Innove. Usuario: ${USER.name} ${USER.emoji}. Ajusta la explicación a Nivel ${depth}/150.`; if(attachments.some(a=>a.type==='pdf')) s += "\n\nNota: hay PDF adjunto (resumen parcial)."; return s; }
    function buildMessages(userText){ const msgs=[{role:'system',content:systemPrompt()}]; if(userText) msgs.push({role:'user',content:userText}); return msgs; }
    async function callAI({provider, model, messages, stream}){ if(USE_PROXY){ return fetch(PROXY_URL,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({provider,model,messages,stream})}); } if(provider==='openai' && OPENAI_KEY){ return fetch('https://api.openai.com/v1/chat/completions',{method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+OPENAI_KEY}, body:JSON.stringify({model,messages,stream})}); } const fallback = {choices:[{message:{content:'(Conecta tu proxy para usar '+provider+')'}}]}; return new Response(new Blob([JSON.stringify(fallback)],{type:'application/json'}),{ok:true}); }

    // ===== Scroll helper =====
    chatEl.addEventListener('scroll',()=>{ const nearBottom=chatEl.scrollHeight-chatEl.scrollTop-chatEl.clientHeight<120; toBottomBtn.style.display=nearBottom?'none':'block'; });
    toBottomBtn.addEventListener('click',()=> chatEl.scrollTo({top:chatEl.scrollHeight, behavior:'smooth'}));
    function jiggleToBottom(){ toBottomBtn.style.display='block'; toBottomBtn.animate([{transform:'translateY(0)'},{transform:'translateY(-3px)'},{transform:'translateY(0)'}],{duration:380,iterations:1}); }

    // ===== Confeti + Misiones =====
    function confetti(){ const n=60; for(let i=0;i<n;i++){ const p=document.createElement('div'); const size=4+Math.random()*6; const left=10+Math.random()*80; const rot=Math.random()*360; p.style.cssText=`position:fixed;top:-10px;left:${left}vw;width:${size}px;height:${size}px;background:hsl(${Math.random()*360} 90% 60%);border-radius:2px;transform:rotate(${rot}deg);z-index:9999;opacity:.9;`; document.body.appendChild(p); const y=100+Math.random()*100; const x=(Math.random()-.5)*40; p.animate([{transform:`translate(0,0) rotate(${rot}deg)`},{transform:`translate(${x}vw,${y}vh) rotate(${rot+720}deg)`}],{duration:900+Math.random()*700,easing:'ease-out'}).onfinish=()=>p.remove(); } }
    const QUESTS_BASE=[{id:'saludar', text:'Envía tu primer mensaje', xp:40},{id:'formula', text:'Usa una fórmula ($...$ o \\ce{...})', xp:30},{id:'archivo', text:'Adjunta un archivo', xp:30}];
    const questsEl=document.getElementById('quests');
    const doneQuests=JSON.parse(localStorage.getItem('innove-quests')||'[]');
    function renderQuests(){ questsEl.innerHTML=''; for(const q of QUESTS_BASE){ const row=document.createElement('div'); row.className='quest'; row.style.cssText='display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:var(--glass)'; const left=document.createElement('div'); left.textContent=q.text+` (+${q.xp} XP)`; const btn=document.createElement('button'); btn.className='chip'; btn.textContent=doneQuests.includes(q.id)?'✅ Hecho':'Tomar'; btn.disabled=doneQuests.includes(q.id); btn.onclick=()=>{ if(!doneQuests.includes(q.id)){ doneQuests.push(q.id); localStorage.setItem('innove-quests', JSON.stringify(doneQuests)); addXP(q.xp); renderQuests(); burstEmoji(btn.getBoundingClientRect().left, btn.getBoundingClientRect().top, ['✨','⭐','💫']); } }; row.appendChild(left); row.appendChild(btn); questsEl.appendChild(row);} }
    renderQuests();

    // ===== Efectos extra =====
    function animateSendPlane(){ const rect=sendBtn.getBoundingClientRect(); const el=document.createElement('div'); el.className='float-emoji'; el.textContent='🛩️'; el.style.left=rect.left+'px'; el.style.top=rect.top+'px'; el.style.position='fixed'; el.style.fontSize='18px'; el.style.pointerEvents='none'; el.style.zIndex='9999'; document.body.appendChild(el); el.animate([{transform:'translate(0,0) rotate(0)'},{transform:'translate(120px,-140px) rotate(25deg)'},{transform:'translate(240px,-260px) rotate(35deg)', opacity:.2}],{duration:900, easing:'ease-out'}).onfinish=()=>el.remove(); }
    function burstEmoji(x,y,emojis=['✨']){ for(let i=0;i<12;i++){ const e=document.createElement('div'); e.className='float-emoji'; e.textContent=emojis[Math.floor(Math.random()*emojis.length)]; e.style.position='fixed'; e.style.left=(x)+'px'; e.style.top=(y)+'px'; e.style.fontSize='18px'; e.style.pointerEvents='none'; e.style.zIndex='9999'; document.body.appendChild(e); const dx=(Math.random()-.5)*140; const dy=(Math.random()-.8)*200-40; const rot=(Math.random()*90-45); const dur=500+Math.random()*700; e.animate([{transform:'translate(0,0) scale(.8)'},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg) scale(1.1)`, opacity:0}],{duration:dur, easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>e.remove(); } }

    // Bienvenida
    addMsg('ai','✨ v4.1 lista. En móvil el chat ocupa toda la pantalla y el composer queda fijo. ¡Prueba enviar un mensaje!');
  </script>
</body>
</html>


